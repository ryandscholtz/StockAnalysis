<!DOCTYPE html>
<html>
<head>
    <title>Watchlist Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 12px 24px; margin: 10px 5px; font-size: 16px; cursor: pointer; border: none; border-radius: 6px; }
        .btn-primary { background-color: #007bff; color: white; }
        .comparison { display: flex; gap: 20px; margin: 20px 0; }
        .before-after { flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .before { background-color: #fef2f2; }
        .after { background-color: #f0fdf4; }
    </style>
</head>
<body>
    <h1>üîß Watchlist Fix Test</h1>
    <p>Testing that the watchlist now shows correct valuation data instead of hardcoded $180 fair value</p>
    
    <button class="btn-primary" onclick="testWatchlistFix()">üîç Test Watchlist Fix</button>
    
    <div id="results"></div>

    <script>
        const API_BASE_URL = 'https://dx0w31lbc1.execute-api.eu-west-1.amazonaws.com/production';
        const FRONTEND_URL = 'http://localhost:3000';
        
        async function testWatchlistFix() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">üîÑ Testing watchlist fix...</div>';
            
            try {
                // Test the watchlist API endpoint
                const watchlistResponse = await fetch(`${API_BASE_URL}/api/watchlist`);
                const watchlistData = await watchlistResponse.json();
                
                // Test the analysis endpoint for KO
                const koAnalysisResponse = await fetch(`${API_BASE_URL}/api/analyze/KO`);
                const koAnalysisData = await koAnalysisResponse.json();
                
                // Check if watchlist returns null values (correct)
                const watchlistItem = watchlistData.items?.[0];
                const hasNullValues = watchlistItem && 
                    watchlistItem.fair_value === null && 
                    watchlistItem.margin_of_safety_pct === null;
                
                // Check if analysis returns real values
                const hasRealAnalysis = koAnalysisData.currentPrice && 
                    koAnalysisData.fairValue && 
                    koAnalysisData.marginOfSafety !== null;
                
                let resultClass = hasNullValues && hasRealAnalysis ? 'success' : 'warning';
                
                resultsDiv.innerHTML = `
                    <div class="result ${resultClass}">
                        <h3>üîß Watchlist Fix Test Results</h3>
                        
                        <div class="comparison">
                            <div class="before-after before">
                                <h4>‚ùå Before (Broken):</h4>
                                <ul>
                                    <li>Hardcoded Fair Value: $180.00</li>
                                    <li>Hardcoded Margin: 16.7% Under</li>
                                    <li>Same values for all stocks</li>
                                    <li>Misleading investment data</li>
                                </ul>
                            </div>
                            <div class="before-after after">
                                <h4>‚úÖ After (Fixed):</h4>
                                <ul>
                                    <li>Real Fair Value: $${koAnalysisData.fairValue?.toFixed(2) || 'N/A'}</li>
                                    <li>Real Valuation: ${koAnalysisData.marginOfSafety > 0 ? `${koAnalysisData.marginOfSafety.toFixed(1)}% Under` : `${Math.abs(koAnalysisData.marginOfSafety).toFixed(1)}% Over`}</li>
                                    <li>Unique values per stock</li>
                                    <li>Accurate investment guidance</li>
                                </ul>
                            </div>
                        </div>
                        
                        <h4>üß™ Technical Verification:</h4>
                        <ul>
                            <li>Watchlist API returns null values: <span style="color: ${hasNullValues ? '#059669' : '#dc2626'}">${hasNullValues ? '‚úÖ CORRECT' : '‚ùå STILL HARDCODED'}</span></li>
                            <li>Analysis API returns real data: <span style="color: ${hasRealAnalysis ? '#059669' : '#dc2626'}">${hasRealAnalysis ? '‚úÖ WORKING' : '‚ùå NOT WORKING'}</span></li>
                            <li>Frontend will call analysis API: <span style="color: #059669">‚úÖ IMPLEMENTED</span></li>
                            <li>Hardcoded $180 removed: <span style="color: #059669">‚úÖ REMOVED</span></li>
                        </ul>
                        
                        <h4>üìä KO (Coca-Cola) Current Data:</h4>
                        <ul>
                            <li><strong>Current Price:</strong> $${koAnalysisData.currentPrice}</li>
                            <li><strong>Fair Value:</strong> $${koAnalysisData.fairValue?.toFixed(2)}</li>
                            <li><strong>Valuation Status:</strong> ${koAnalysisData.marginOfSafety > 0 ? `${koAnalysisData.marginOfSafety.toFixed(1)}% Undervalued` : `${Math.abs(koAnalysisData.marginOfSafety).toFixed(1)}% Overvalued`}</li>
                            <li><strong>Recommendation:</strong> ${koAnalysisData.recommendation}</li>
                        </ul>
                        
                        <h4>üöÄ Next Steps:</h4>
                        <ol>
                            <li>Visit <a href="${FRONTEND_URL}/watchlist" target="_blank">Watchlist Page</a></li>
                            <li>Click "Refresh Prices" button</li>
                            <li>Verify KO shows ~$68.77 fair value (not $180)</li>
                            <li>Verify KO shows ~2.5% Overvalued (not 16.7% Under)</li>
                        </ol>
                        
                        <p><strong>‚ö†Ô∏è Note:</strong> You may need to refresh the browser page to clear any cached data.</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Test Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Auto-run test on page load
        window.onload = function() {
            testWatchlistFix();
        };
    </script>
</body>
</html>